# Generated by Django 2.2.10 on 2020-03-09 22:04
from django.contrib.postgres.indexes import GinIndex
from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [("reporting", "0101_ocpenabledtagkeys"), ("reporting_common", "0021_source_service_product")]

    operations = [
        # Add index to usage_start on 2 materialized views for ocp_all
        migrations.RunSQL(
            sql="""
DROP INDEX IF EXISTS ocpallcstprjdlysumm_usage_start;
CREATE INDEX ocpallcstprjdlysumm_usage_start ON reporting_ocpallcostlineitem_project_daily_summary (usage_start);

DROP INDEX IF EXISTS ocpallcstdlysumm_usage_start;
CREATE INDEX ocpallcstdlysumm_usage_start on reporting_ocpallcostlineitem_daily_summary (usage_start);

DROP INDEX IF EXISTS ocpallcstdlysumm_prod_code_ilike;
CREATE INDEX ocpallcstdlysumm_prod_code_ilike ON reporting_ocpallcostlineitem_daily_summary USING GIN (upper(product_code) gin_trgm_ops);

DROP INDEX IF EXISTS ocpallcstdlysumm_prod_code_like;
CREATE INDEX ocpallcstdlysumm_prod_code_like ON reporting_ocpallcostlineitem_daily_summary USING GIN (product_code gin_trgm_ops);

DROP INDEX IF EXISTS ocpallcstdlysumm_prod_family_ilike;
CREATE INDEX ocpallcstdlysumm_prod_family_ilike ON reporting_ocpallcostlineitem_daily_summary USING GIN (upper(product_family) gin_trgm_ops);

DROP INDEX IF EXISTS ocpallcstdlysumm_prod_family_like;
CREATE INDEX ocpallcstdlysumm_prod_family_like ON reporting_ocpallcostlineitem_daily_summary USING GIN (product_family gin_trgm_ops);
            """
        ),
        migrations.RemoveIndex(model_name="ocpawscostlineitemdailysummary", name="cost_summary_namespace_idx"),
        migrations.RemoveIndex(model_name="ocpazurecostlineitemdailysummary", name="ocpazure_namespace_idx"),
        migrations.AddIndex(
            model_name="ocpawscostlineitemdailysummary",
            index=GinIndex(fields=["namespace"], name="cost_summary_namespace_idx"),
        ),
        migrations.AddIndex(
            model_name="ocpazurecostlineitemdailysummary",
            index=GinIndex(fields=["namespace"], name="ocpazure_namespace_idx"),
        ),
        migrations.RunSQL(
            sql="""
DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_daily_summary_database;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_daily_summary_database AS
SELECT row_number() OVER () AS id,
       lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.markup_cost) as "markup_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'database'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ix_reporting_ocpallcost_lids_db_cluster_id
    ON reporting_ocpallcostlineitem_daily_summary_database (cluster_id);
CREATE INDEX ix_reporting_ocpallcost_lids_db_cluster_alias
    ON reporting_ocpallcostlineitem_daily_summary_database (cluster_alias);
CREATE INDEX ix_reporting_ocpallcost_lids_db_usage_start
    ON reporting_ocpallcostlineitem_daily_summary_database (usage_start);
CREATE INDEX ix_reporting_ocpallcost_lids_db_prod_code_ilike
    ON reporting_ocpallcostlineitem_daily_summary_database USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcost_lids_db_prod_code_like
    ON reporting_ocpallcostlineitem_daily_summary_database USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_daily_summary_compute;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_daily_summary_compute AS
SELECT row_number() OVER () AS id,
       lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.markup_cost) as "markup_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'compute'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ix_reporting_ocpallcost_lids_cp_cluster_id
    ON reporting_ocpallcostlineitem_daily_summary_compute (cluster_id);
CREATE INDEX ix_reporting_ocpallcost_lids_cp_cluster_alias
    ON reporting_ocpallcostlineitem_daily_summary_compute (cluster_alias);
CREATE INDEX ix_reporting_ocpallcost_lids_cp_usage_start
    ON reporting_ocpallcostlineitem_daily_summary_compute (usage_start);
CREATE INDEX ix_reporting_ocpallcost_lids_cp_prod_code_ilike
    ON reporting_ocpallcostlineitem_daily_summary_compute USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcost_lids_cp_prod_code_like
    ON reporting_ocpallcostlineitem_daily_summary_compute USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_daily_summary_network;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_daily_summary_network AS
SELECT row_number() OVER () AS id,
       lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.markup_cost) as "markup_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'network'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ix_reporting_ocpallcost_lids_nw_cluster_id
    ON reporting_ocpallcostlineitem_daily_summary_network (cluster_id);
CREATE INDEX ix_reporting_ocpallcost_lids_nw_cluster_alias
    ON reporting_ocpallcostlineitem_daily_summary_network (cluster_alias);
CREATE INDEX ix_reporting_ocpallcost_lids_nw_usage_start
    ON reporting_ocpallcostlineitem_daily_summary_network (usage_start);
CREATE INDEX ix_reporting_ocpallcost_lids_nw_prod_code_ilike
    ON reporting_ocpallcostlineitem_daily_summary_network USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcost_lids_nw_prod_code_like
    ON reporting_ocpallcostlineitem_daily_summary_network USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_daily_summary_storage;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_daily_summary_storage AS
SELECT row_number() OVER () AS id,
       lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.markup_cost) as "markup_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'storage'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.cluster_id,
       lids.cluster_alias,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ix_reporting_ocpallcost_lids_st_cluster_id
    ON reporting_ocpallcostlineitem_daily_summary_storage (cluster_id);
CREATE INDEX ix_reporting_ocpallcost_lids_st_cluster_alias
    ON reporting_ocpallcostlineitem_daily_summary_storage (cluster_alias);
CREATE INDEX ix_reporting_ocpallcost_lids_st_usage_start
    ON reporting_ocpallcostlineitem_daily_summary_storage (usage_start);
CREATE INDEX ix_reporting_ocpallcost_lids_st_prod_code_ilike
    ON reporting_ocpallcostlineitem_daily_summary_storage USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcost_lids_st_prod_code_like
    ON reporting_ocpallcostlineitem_daily_summary_storage USING GIN (product_code gin_trgm_ops);


-- ================


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_project_daily_summary_compute;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_project_daily_summary_compute AS
SELECT row_number() OVER () AS id,
       lids.namespace,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.project_markup_cost) as "project_markup_cost",
       sum(lids.pod_cost) as "pod_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_project_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'compute'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.namespace,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ocpallcstprjdlysumm_cp_nsp
    ON reporting_ocpallcostlineitem_project_daily_summary_compute (namespace text_pattern_ops);
CREATE INDEX ocpallcstprjdlysumm_cp_nsp_like
    ON reporting_ocpallcostlineitem_project_daily_summary_compute USING GIN (namespace gin_trgm_ops);
CREATE INDEX ocpallcstprjdlysumm_cp_usage_start
    ON reporting_ocpallcostlineitem_project_daily_summary_compute (usage_start);
CREATE INDEX ix_reporting_ocpallcostprj_lids_cp_prod_code_ilike
    ON reporting_ocpallcostlineitem_project_daily_summary_compute USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcostprj_lids_cp_prod_code_like
    ON reporting_ocpallcostlineitem_project_daily_summary_compute USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_project_daily_summary_storage;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_project_daily_summary_storage AS
SELECT row_number() OVER () AS id,
       lids.namespace,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.project_markup_cost) as "project_markup_cost",
       sum(lids.pod_cost) as "pod_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_project_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'storage'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.namespace,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ocpallcstprjdlysumm_st_nsp
    ON reporting_ocpallcostlineitem_project_daily_summary_storage (namespace text_pattern_ops);
CREATE INDEX ocpallcstprjdlysumm_st_nsp_like
    ON reporting_ocpallcostlineitem_project_daily_summary_storage USING GIN (namespace gin_trgm_ops);
CREATE INDEX ocpallcstprjdlysumm_st_usage_start
    ON reporting_ocpallcostlineitem_project_daily_summary_storage (usage_start);
CREATE INDEX ix_reporting_ocpallcostprj_lids_st_prod_code_ilike
    ON reporting_ocpallcostlineitem_project_daily_summary_storage USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcostprj_lids_st_prod_code_like
    ON reporting_ocpallcostlineitem_project_daily_summary_storage USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_project_daily_summary_network;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_project_daily_summary_network AS
SELECT row_number() OVER () AS id,
       lids.namespace,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.project_markup_cost) as "project_markup_cost",
       sum(lids.pod_cost) as "pod_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_project_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'network'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.namespace,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ocpallcstprjdlysumm_nw_nsp
    ON reporting_ocpallcostlineitem_project_daily_summary_network (namespace text_pattern_ops);
CREATE INDEX ocpallcstprjdlysumm_nw_nsp_like
    ON reporting_ocpallcostlineitem_project_daily_summary_network USING GIN (namespace gin_trgm_ops);
CREATE INDEX ocpallcstprjdlysumm_nw_usage_start
    ON reporting_ocpallcostlineitem_project_daily_summary_network (usage_start);
CREATE INDEX ix_reporting_ocpallcostprj_lids_nw_prod_code_ilike
    ON reporting_ocpallcostlineitem_project_daily_summary_network USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcostprj_lids_nw_prod_code_like
    ON reporting_ocpallcostlineitem_project_daily_summary_network USING GIN (product_code gin_trgm_ops);


DROP MATERIALIZED VIEW IF EXISTS reporting_ocpallcostlineitem_project_daily_summary_database;
CREATE MATERIALIZED VIEW reporting_ocpallcostlineitem_project_daily_summary_database AS
SELECT row_number() OVER () AS id,
       lids.namespace,
       lids.usage_start,
       lids.usage_start as "usage_end",
       lids.product_code,
       sum(lids.usage_amount) as "usage_amount",
       max(lids.unit) as "unit",
       sum(lids.unblended_cost) as "unblended_cost",
       sum(lids.project_markup_cost) as "project_markup_cost",
       sum(lids.pod_cost) as "pod_cost",
       max(lids.currency_code) as "currency_code"
  FROM reporting_ocpallcostlineitem_project_daily_summary lids
  JOIN reporting_common_sourceserviceproduct rcssp
    ON rcssp.source = lids.source_type
   AND rcssp.service_category = 'database'
   AND lids.product_code = any(rcssp.product_codes)
 GROUP
    BY lids.namespace,
       lids.usage_start,
       lids.product_code
  WITH DATA;

CREATE INDEX ocpallcstprjdlysumm_db_nsp
    ON reporting_ocpallcostlineitem_project_daily_summary_database (namespace text_pattern_ops);
CREATE INDEX ocpallcstprjdlysumm_db_nsp_like
    ON reporting_ocpallcostlineitem_project_daily_summary_database USING GIN (namespace gin_trgm_ops);
CREATE INDEX ocpallcstprjdlysumm_db_usage_start
    ON reporting_ocpallcostlineitem_project_daily_summary_database (usage_start);
CREATE INDEX ix_reporting_ocpallcostprj_lids_db_prod_code_ilike
    ON reporting_ocpallcostlineitem_project_daily_summary_database USING GIN (upper(product_code) gin_trgm_ops);
CREATE INDEX ix_reporting_ocpallcostprj_lids_db_prod_code_like
    ON reporting_ocpallcostlineitem_project_daily_summary_database USING GIN (product_code gin_trgm_ops);

            """
        ),
    ]
