# Generated by Django 2.2.11 on 2020-03-26 19:53
from django.db import migrations
from django.db import models


class Migration(migrations.Migration):

    dependencies = [
        (
            "reporting",
            "0103_azurecomputesummary_azurecostsummary_azurecostsummarybyaccount_azurecostsummarybylocation_azurecosts",
        )
    ]

    operations = [
        migrations.CreateModel(
            name="OCPAllComputeSummary",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("product_code", models.CharField(max_length=50)),
                ("instance_type", models.CharField(max_length=50)),
                ("resource_id", models.CharField(max_length=253)),
                ("usage_amount", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("unit", models.CharField(max_length=63, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("currency_code", models.CharField(max_length=10, null=True)),
            ],
            options={"db_table": "reporting_ocpall_compute_summary", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllCostSummary",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("currency_code", models.CharField(max_length=10)),
            ],
            options={"db_table": "reporting_ocpall_cost_summary", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllCostSummaryByAccount",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("usage_account_id", models.CharField(max_length=50)),
                ("unblended_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("currency_code", models.CharField(max_length=10)),
            ],
            options={"db_table": "reporting_ocpall_cost_summary_by_account", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllCostSummaryByRegion",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("region", models.CharField(max_length=50, null=True)),
                ("availability_zone", models.CharField(max_length=50, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("currency_code", models.CharField(max_length=10)),
            ],
            options={"db_table": "reporting_ocpall_cost_summary_by_region", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllCostSummaryByService",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("product_code", models.CharField(max_length=50)),
                ("product_family", models.CharField(max_length=150, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=9, max_digits=24, null=True)),
                ("currency_code", models.CharField(max_length=10)),
            ],
            options={"db_table": "reporting_ocpall_cost_summary_by_service", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllDatabaseSummary",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("product_code", models.CharField(max_length=50)),
                ("usage_amount", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("unit", models.CharField(max_length=63, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("currency_code", models.CharField(max_length=10, null=True)),
            ],
            options={"db_table": "reporting_ocpall_database_summary", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllNetworkSummary",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("product_code", models.CharField(max_length=50)),
                ("usage_amount", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("unit", models.CharField(max_length=63, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("currency_code", models.CharField(max_length=10, null=True)),
            ],
            options={"db_table": "reporting_ocpall_network_summary", "managed": False},
        ),
        migrations.CreateModel(
            name="OCPAllStorageSummary",
            fields=[
                ("id", models.IntegerField(primary_key=True, serialize=False)),
                ("cluster_id", models.CharField(max_length=50, null=True)),
                ("cluster_alias", models.CharField(max_length=256, null=True)),
                ("usage_start", models.DateField()),
                ("usage_end", models.DateField()),
                ("product_family", models.CharField(max_length=150, null=True)),
                ("product_code", models.CharField(max_length=50)),
                ("usage_amount", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("unit", models.CharField(max_length=63, null=True)),
                ("unblended_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("markup_cost", models.DecimalField(decimal_places=15, max_digits=30, null=True)),
                ("currency_code", models.CharField(max_length=10, null=True)),
            ],
            options={"db_table": "reporting_ocpall_storage_summary", "managed": False},
        ),
        migrations.RunSQL(
            """
            CREATE MATERIALIZED VIEW reporting_ocpall_cost_summary AS(
                SELECT row_number() OVER(ORDER BY usage_start, cluster_id, cluster_alias) as id,
                    usage_start as usage_start,
                    usage_start as usage_end,
                    cluster_id,
                    cluster_alias,
                    sum(unblended_cost) as unblended_cost,
                    sum(markup_cost) as markup_cost,
                    max(currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary
                -- Get data for this month or last month
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                GROUP BY usage_start, cluster_id, cluster_alias
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_cost_summary
            ON reporting_ocpall_cost_summary (usage_start, cluster_id, cluster_alias)
            ;

            CREATE MATERIALIZED VIEW reporting_ocpall_cost_summary_by_account AS(
                SELECT row_number() OVER(ORDER BY usage_start, cluster_id, cluster_alias, usage_account_id, account_alias_id) as id,
                    usage_start as usage_start,
                    usage_start as usage_end,
                    cluster_id,
                    cluster_alias,
                    usage_account_id,
                    account_alias_id,
                    sum(unblended_cost) as unblended_cost,
                    sum(markup_cost) as markup_cost,
                    max(currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary
                -- Get data for this month or last month
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                GROUP BY usage_start, cluster_id, cluster_alias, usage_account_id, account_alias_id
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_cost_summary_account
            ON reporting_ocpall_cost_summary_by_account (usage_start, cluster_id, cluster_alias, usage_account_id, account_alias_id)
            ;

            CREATE MATERIALIZED VIEW reporting_ocpall_cost_summary_by_service AS(
                SELECT row_number() OVER(ORDER BY usage_start, cluster_id, cluster_alias, product_code, product_family) as id,
                    usage_start as usage_start,
                    usage_start as usage_end,
                    cluster_id,
                    cluster_alias,
                    product_code,
                    product_family,
                    sum(unblended_cost) as unblended_cost,
                    sum(markup_cost) as markup_cost,
                    max(currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary
                -- Get data for this month or last month
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                GROUP BY usage_start, cluster_id, cluster_alias, product_code, product_family
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_cost_summary_service
            ON reporting_ocpall_cost_summary_by_service (usage_start, cluster_id, cluster_alias, product_code, product_family)
            ;

            CREATE MATERIALIZED VIEW reporting_ocpall_cost_summary_by_region AS(
                SELECT row_number() OVER(ORDER BY usage_start, cluster_id, cluster_alias, region, availability_zone) as id,
                    usage_start as usage_start,
                    usage_start as usage_end,
                    cluster_id,
                    cluster_alias,
                    region,
                    availability_zone,
                    sum(unblended_cost) as unblended_cost,
                    sum(markup_cost) as markup_cost,
                    max(currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary
                -- Get data for this month or last month
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                GROUP BY usage_start, cluster_id, cluster_alias, region, availability_zone
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_cost_summary_region
            ON reporting_ocpall_cost_summary_by_region (usage_start, cluster_id, cluster_alias, region, availability_zone)
            ;

            DROP MATERIALIZED VIEW IF EXISTS reporting_ocpall_compute_summary;
            CREATE MATERIALIZED VIEW reporting_ocpall_compute_summary AS (
                SELECT row_number() OVER (ORDER BY usage_start, cluster_id, cluster_alias, product_code) AS id,
                    lids.usage_start,
                    lids.usage_start as usage_end,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.product_code,
                    lids.instance_type,
                    lids.resource_id,
                    sum(lids.usage_amount) as usage_amount,
                    max(lids.unit) as unit,
                    sum(lids.unblended_cost) as unblended_cost,
                    sum(lids.markup_cost) as markup_cost,
                    max(lids.currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary lids
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                    AND instance_type IS NOT NULL
                GROUP BY lids.usage_start,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.product_code,
                    lids.instance_type,
                    lids.resource_id
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_compute_summary
            ON reporting_ocpall_compute_summary (usage_start, cluster_id, cluster_alias, product_code, instance_type, resource_id);

            DROP MATERIALIZED VIEW IF EXISTS reporting_ocpall_database_summary;
            CREATE MATERIALIZED VIEW reporting_ocpall_database_summary AS (
                SELECT row_number() OVER (ORDER BY usage_start, cluster_id, cluster_alias, product_code) AS id,
                    lids.usage_start,
                    lids.usage_start as usage_end,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.product_code,
                    sum(lids.usage_amount) as usage_amount,
                    max(lids.unit) as unit,
                    sum(lids.unblended_cost) as unblended_cost,
                    sum(lids.markup_cost) as markup_cost,
                    max(lids.currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary lids
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                    AND (
                        product_code IN ('AmazonRDS','AmazonDynamoDB','AmazonElastiCache','AmazonNeptune','AmazonRedshift','AmazonDocumentDB','Cosmos DB','Cache for Redis')
                            OR product_code LIKE '%Database%'
                    )
                GROUP BY lids.usage_start,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.product_code
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_database_summary
            ON reporting_ocpall_database_summary (usage_start, cluster_id, cluster_alias, product_code)
            ;

            DROP MATERIALIZED VIEW IF EXISTS reporting_ocpall_network_summary;
            CREATE MATERIALIZED VIEW reporting_ocpall_network_summary AS (
                SELECT row_number() OVER (ORDER BY usage_start, cluster_id, cluster_alias, product_code) AS id,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.usage_start,
                    lids.usage_start as usage_end,
                    lids.product_code,
                    sum(lids.usage_amount) as usage_amount,
                    max(lids.unit) as unit,
                    sum(lids.unblended_cost) as unblended_cost,
                    sum(lids.markup_cost) as markup_cost,
                    max(lids.currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary lids
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                    AND product_code IN ('AmazonVPC','AmazonCloudFront','AmazonRoute53','AmazonAPIGateway','Virtual Network','VPN','DNS','Traffic Manager','ExpressRoute','Load Balancer','Application Gateway')
                GROUP BY lids.usage_start,
                    lids.cluster_id,
                    lids.cluster_alias,
                    lids.product_code
            )
            WITH DATA
            ;

            CREATE UNIQUE INDEX ocpall_network_summary
            ON reporting_ocpall_network_summary (usage_start, cluster_id, cluster_alias, product_code)
            ;

            DROP MATERIALIZED VIEW IF EXISTS reporting_ocpall_storage_summary;
            CREATE MATERIALIZED VIEW reporting_ocpall_storage_summary AS (
                SELECT row_number() OVER (ORDER BY usage_start, cluster_id, cluster_alias, product_family, product_code) AS id,
                    cluster_id,
                    cluster_alias,
                    usage_start,
                    usage_start as usage_end,
                    product_family,
                    product_code,
                    sum(usage_amount) as usage_amount,
                    max(unit) as unit,
                    sum(unblended_cost) as unblended_cost,
                    sum(markup_cost) as markup_cost,
                    max(currency_code) as currency_code
                FROM reporting_ocpallcostlineitem_daily_summary
                WHERE usage_start >= DATE_TRUNC('month', NOW() - '1 month'::interval)::date
                    AND (product_family LIKE '%Storage%' OR product_code LIKE '%Storage%')
                GROUP BY usage_start,
                    cluster_id,
                    cluster_alias,
                    product_family,
                    product_code
            )
            WITH DATA
            ;

            CREATE INDEX ocpall_storage_summary
            ON reporting_ocpall_storage_summary (usage_start, cluster_id, cluster_alias, product_family, product_code)
            ;
            """
        ),
    ]
