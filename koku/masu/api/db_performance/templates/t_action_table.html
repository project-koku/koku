<!--
Copyright 2022 Red Hat Inc.
SPDX-License-Identifier: Apache-2.0
-->
<html>
    <head>
        <title>Cost Management DB Performance Statistics</title>
        <style>
            .pre {white-space: pre;}
            .monospace {font-family: 'Courier New', Courier, monospace;}
            .sans {font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;}
            .left-btn {float: left}
            .right-btn {float: right}
            hr {width: 100%;}
            tbody > tr:not(:first-child) > td {border-top: 1px solid black;}
            tbody > tr:nth-child(even) {background-color: #e7e7e7;}
            th, td {vertical-align: top; padding-left: 0.5em; padding-right: 0.5em;}
            th {border-bottom: 1px solid black; background-color: #cecece;}
            th:not(:first-child) {border-left: 1px solid black;}
            td:not(:first-child) {border-left: 1px solid black;}
        </style>
        <script>
            function do_terminate(target_id) {
                var cell = document.getElementById(target_id);
                var pid = cell.innerText;
                var terminate_url = '{{action_urls[1]}}';
                _msg = "Terminate backend pid: " + pid + " ?\n"
                       + "This will close the connection.";
                if ( window.confirm(_msg) ) {
                    _msg = 'Enter "TERMINATE" to terminate connection: ' + pid;
                    var reconfirm = window.prompt(_msg);
                    if ((reconfirm !== null) && (reconfirm == "TERMINATE")) {
                        var xhttp = new XMLHttpRequest();
                        var terminate_data = null;
                        xhttp.open("GET", terminate_url, false);
                        xhttp.setRequestHeader("PARAM-DB-CONNID", pid)
                        xhttp.send()
                        if (xhttp.status == 200) {
                            terminate_data = JSON.parse(xhttp.responseText)[0]
                            _msg = "Successful request sent.\n"
                                + "Response:\n"
                                + "Pid: "
                                + terminate_data.pid
                                + " Terminated: "
                                + terminate_data.terminate
                            window.alert(_msg)
                            location.reload()
                        } else {
                            window.alert("Request failed: " + xhttp.statusText + " (" + xhttp.status + ")");
                        }
                    }
                }
            }

            function do_cancel(target_id) {
                var cell = document.getElementById(target_id);
                var pid = cell.innerText;
                var cancel_url = '{{action_urls[0]}}';
                _msg = "Cancel backend pid: " + pid + " ?\n"
                              + "This will halt the current action for that connection.";
                if ( window.confirm(_msg) ) {
                    var xhttp = new XMLHttpRequest();
                    var cancel_data = null;
                    xhttp.open("GET", cancel_url, false);
                    xhttp.setRequestHeader("PARAM-DB-CONNID", pid)
                    xhttp.send()
                    if (xhttp.status == 200) {
                        cancel_data = JSON.parse(xhttp.responseText)[0]
                        _msg = "Successful request sent.\n"
                               + "Response:\n"
                               + "Pid: "
                               + cancel_data.pid
                               + " Cancelled: "
                               + cancel_data.cancel
                        window.alert(_msg)
                        location.reload()
                    }
                }
            }
        </script>
    </head>
    <body>
        <h1>Database Performance</h1>
        <hr />
        <h2 id="data_header">{{page_header}}</h2>
        <table id="term_action_table" cellspacing="0">
{% for rec in data %}
    {% set rec_loop = loop %}
    {% if loop.first %}
            <thead>
                <tr>
                    <th>Action</th>
        {% for field in fields %}
                        <th id="{{field}}-h">{{field}}</th>
        {% endfor %}
                </tr>
            </thead>
            <tbody>
    {% endif %}
                <tr>
                    <td id="row-{{rec_loop.index}}.action">
                        <div>
    {% for target in targets %}
                            <button class="left-btn" id="cancel-{{target}}-{{rec_loop.index}}" onclick="do_cancel('{{target}}-{{rec_loop.index}}');">Cancel {{target}} {{rec[target]}}</button>
                            <span style="display:inline-block; width:1em;"></span>
                            <button class="right-btn" id="terminate-{{target}}-{{rec_loop.index}}" onclick="do_terminate('{{target}}-{{rec_loop.index}}');">Terminate {{target}} {{rec[target]}}</button>
                            <br/>
   {% endfor %}
                        </div>
                    </td>
    {% for field in fields %}
                    <td id="{{field}}-{{rec_loop.index}}" {% if field in rec.get("attrs", {}) %} {{rec["attrs"][field]}} {% endif %}>{{rec[field]}}</td>
    {% endfor %}
                </tr>
    {% if rec_loop.last %}
            </tbody>
    {% endif %}
{% endfor %}
        </table>
    </body>
</html>
