---
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: db-migrations
objects:
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdApp
  metadata:
    name: db-migrations
  spec:
    database:
      sharedDbAppName: koku
    dependencies:
      - koku
    envName: ${ENV_NAME}
    jobs:
    - name: koku-mig-cji-${IMAGE_TAG}
      podSpec:
        args:
        - /bin/bash
        - -c
        - $HOME/scripts/run_migrations.sh
        env:
        # - name: PRESTO_HOST
        #   value: ${PRESTO_HOST}
        # - name: PRESTO_PORT
        #   value: ${PRESTO_PORT}
        # - name: PROMETHEUS_MULTIPROC_DIR
        #   value: ${PROMETHEUS_DIR}
        - name: REDIS_HOST
          value: ${REDIS_HOST}
        - name: REDIS_PORT
          value: ${REDIS_PORT}
        - name: CLOWDER_ENABLED
          value: ${CLOWDER_ENABLED}
        - name: _MIGRATION_DIRECTIVE
          value: ${_MIGRATION_DIRECTIVE}
        image: ${IMAGE}:${IMAGE_TAG}
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdJobInvocation
  metadata:
    name: koku-mig-cji-${IMAGE_TAG}
  spec:
    appName: koku-mig-cji
    jobs:
      - koku-mig-cji-${IMAGE_TAG}
parameters:
- name: ENV_NAME
  required: true
  value: koku-env
- description: Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- description: Image
  name: IMAGE
  required: true
  value: quay.io/cloudservices/koku
# - displayName: Presto/Trino host
#   name: PRESTO_HOST
#   value: trino-coordinator
# - displayName: Presto/Trino port
#   name: PRESTO_PORT
#   value: "8000"
# - displayName: Prometheus multiproc dir
#   name: PROMETHEUS_DIR
#   value: /tmp
- displayName: in-memory store host
  name: REDIS_HOST
  value: redis
- displayName: in-memory store port
  name: REDIS_PORT
  value: "6379"
- name: CLOWDER_ENABLED
  required: true
  value: "True"
- name: _MIGRATION_DIRECTIVE
  required: true
  value: ""
