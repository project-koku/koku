---
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: koku-migrations
objects:
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdApp
  metadata:
    name: koku-migrations
  spec:
    database:
      sharedDbAppName: koku

    # Use Unleash server
    featureFlags: true

    # Redis
    inMemoryDb: true

    # Request kafka topics for your application here
    kafkaTopics:
    - topicName: platform.sources.event-stream
    - topicName: platform.upload.hccm
    - topicName: platform.upload.validation

    dependencies:
      - koku
    envName: ${ENV_NAME}

    containers:

    jobs:
    - name: koku-migrations-${IMAGE_TAG}
      podSpec:
        containers:
        - name: koku-migrations-${IMAGE_TAG}
          image: ${IMAGE}:${IMAGE_TAG}
          resources:
            limits:
              cpu: ${JOB_CPU_LIMIT}
              memory: ${JOB_MEMORY_LIMIT}
            requests:
              cpu: ${JOB_CPU_REQUEST}
              memory: ${JOB_MEMORY_REQUEST}
          args:
          - /bin/bash
          - -c
          - $HOME/scripts/run_migrations.sh
          env:
          - name: PRESTO_HOST
            value: ${PRESTO_HOST}
          - name: PRESTO_PORT
            value: ${PRESTO_PORT}
          - name: PROMETHEUS_MULTIPROC_DIR
            value: ${PROMETHEUS_DIR}
          - name: REDIS_HOST
            value: ${REDIS_HOST}
          - name: REDIS_PORT
            value: ${REDIS_PORT}
          - name: CLOWDER_ENABLED
            value: ${CLOWDER_ENABLED}
          - name: _MIGRATION_DIRECTIVE
            value: ${_MIGRATION_DIRECTIVE}
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdJobInvocation
  metadata:
    name: koku-migrations-${IMAGE_TAG}
  spec:
    appName: koku-migrations
    jobs:
      - koku-migrations-${IMAGE_TAG}
parameters:
- name: ENV_NAME
  required: true
  value: koku-env
- displayName: Memory Limit
  name: JOB_MEMORY_LIMIT
  required: true
  value: 1Gi
- displayName: CPU Limit
  name: JOB_CPU_LIMIT
  required: true
  value: 600m
- displayName: Memory Request
  name: JOB_MEMORY_REQUEST
  required: true
  value: 500Mi
- displayName: CPU Request
  name: JOB_CPU_REQUEST
  required: true
  value: 300m
- description: Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- description: Image
  name: IMAGE
  required: true
  value: quay.io/cloudservices/koku
- displayName: Presto/Trino host
  name: PRESTO_HOST
  value: trino-coordinator
- displayName: Presto/Trino port
  name: PRESTO_PORT
  value: "8000"
- displayName: Prometheus multiproc dir
  name: PROMETHEUS_DIR
  value: /tmp
- displayName: in-memory store host
  name: REDIS_HOST
  value: redis
- displayName: in-memory store port
  name: REDIS_PORT
  value: "6379"
- name: CLOWDER_ENABLED
  required: true
  value: "True"
- name: _MIGRATION_DIRECTIVE
  required: true
  value: ""
